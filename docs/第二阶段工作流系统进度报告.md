# 第二阶段工作流系统进度报告

## 一、阶段概述

参考 Dify 框架，引入工作流引擎，将硬编码的流程升级为可视化可配置的工作流。

## 二、已完成工作

### 2.1 工作流引擎选型 ✅

**文件**: `docs/工作流引擎选型报告.md`

**决策**: 采用自研轻量级工作流引擎

**理由**:
- 完全可控，轻量级
- 可以完美集成到现有系统
- 可以根据业务需求定制
- 不需要额外部署服务

### 2.2 数据库设计 ✅

**文件**: `database/init/06_workflow_tables.sql`

创建了以下表结构：

1. **workflow_definition** - 工作流定义表
   - 存储工作流的配置信息（JSON格式）
   - 支持版本管理和默认工作流设置

2. **workflow_version** - 工作流版本表
   - 用于版本管理和回滚
   - 记录每个版本的配置

3. **workflow_execution** - 工作流执行记录表
   - 记录每次工作流执行的详细信息
   - 包含输入输出数据、执行状态、错误信息等

4. **workflow_node_execution** - 工作流节点执行记录表
   - 记录每个节点的执行情况
   - 支持节点级别的错误追踪

### 2.3 Java后端实现 ✅

#### 实体类
- `WorkflowDefinition.java` - 工作流定义实体
- `WorkflowVersion.java` - 工作流版本实体
- `WorkflowExecution.java` - 工作流执行记录实体
- `WorkflowNodeExecution.java` - 工作流节点执行记录实体

#### Repository层
- `WorkflowDefinitionRepository.java` - 工作流定义Repository
- `WorkflowVersionRepository.java` - 工作流版本Repository
- `WorkflowExecutionRepository.java` - 工作流执行记录Repository
- `WorkflowNodeExecutionRepository.java` - 工作流节点执行记录Repository

#### Service层
- `WorkflowDefinitionService.java` - 工作流定义服务接口
- `WorkflowDefinitionServiceImpl.java` - 工作流定义服务实现
  - 支持工作流CRUD
  - 支持版本管理
  - 支持工作流配置验证
  - 支持版本回滚

#### Controller层
- `WorkflowDefinitionController.java` - 工作流定义控制器
  - 提供完整的REST API

### 2.4 Python工作流引擎 ✅

**文件**: 
- `app/services/workflow_engine.py` - 工作流执行引擎
- `app/api/workflow_router.py` - 工作流执行API

**已实现功能**:
- ✅ 工作流解析
- ✅ 节点执行框架
- ✅ 流程控制（顺序执行）
- ✅ 执行记录保存
- ✅ 节点执行器注册机制

### 2.5 节点执行器实现 ✅

**文件位置**: `app/services/workflow_nodes/`

**已实现节点类型**:

1. **输入节点** ✅
   - `RequirementInputNode` - 需求文本输入
   - `TestCaseInputNode` - 测试用例输入
   - `FileUploadNode` - 文件上传

2. **处理节点** ✅
   - `RequirementAnalysisNode` - 需求分析
   - `TemplateSelectNode` - 模板选择
   - `PromptGenerateNode` - 提示词生成
   - `LLMCallNode` - 模型调用
   - `ResultParseNode` - 结果解析

3. **转换节点** ✅
   - `FormatTransformNode` - 格式转换
   - `DataCleanNode` - 数据清洗
   - `DataMergeNode` - 数据合并

4. **输出节点** ✅
   - `CaseSaveNode` - 用例保存
   - `ReportGenerateNode` - 报告生成
   - `FileExportNode` - 文件导出

5. **控制节点** ✅
   - `ConditionNode` - 条件判断
   - `LoopNode` - 循环节点

### 2.6 前端基础实现 ✅

**文件位置**:
- `src/api/workflow.ts` - 工作流API封装
- `src/views/workflow/WorkflowEditor.vue` - 工作流编辑器（基础版）

**已实现功能**:
- ✅ 工作流API封装（完整的CRUD和版本管理API）
- ✅ 基础工作流编辑器（拖拽节点、节点配置）
- ⏳ 可视化编辑器（需要安装vue-flow，当前为基础实现）

## 三、待完成工作

### 3.1 前端可视化编辑器增强 ⏳

**需要完成**:
1. 安装vue-flow依赖：`npm install @vue-flow/core @vue-flow/background @vue-flow/controls @vue-flow/minimap`
2. 集成vue-flow到WorkflowEditor
3. 实现节点组件（使用vue-flow的CustomNode）
4. 实现连线功能（使用vue-flow的Edge）
5. 实现节点配置面板增强
6. 实现工作流保存和加载功能

### 3.2 工作流迁移 ⏳

**需要完成**:
1. 设计用例生成工作流
2. 实现用例生成工作流迁移
3. 设计UI脚本生成工作流
4. 实现UI脚本生成工作流迁移

### 3.3 流程控制增强 ⏳

**需要完成**:
1. 实现条件分支（根据条件选择不同路径）
2. 实现循环节点完整功能
3. 实现并行执行（如果需要）

## 四、工作流配置JSON结构示例

```json
{
  "workflow_code": "CASE_GENERATION_V1",
  "workflow_name": "用例生成工作流",
  "nodes": [
    {
      "id": "input_1",
      "type": "requirement_input",
      "name": "需求输入",
      "config": {}
    },
    {
      "id": "process_1",
      "type": "requirement_analysis",
      "name": "需求分析",
      "config": {
        "model_code": "DEEPSEEK_CHAT"
      }
    },
    {
      "id": "process_2",
      "type": "template_select",
      "name": "模板选择",
      "config": {
        "layer_code": "FUNCTIONAL",
        "method_code": "EQUIVALENCE_CLASS"
      }
    },
    {
      "id": "process_3",
      "type": "prompt_generate",
      "name": "提示词生成",
      "config": {}
    },
    {
      "id": "process_4",
      "type": "llm_call",
      "name": "模型调用",
      "config": {
        "model_code": "DEEPSEEK_CHAT"
      }
    },
    {
      "id": "process_5",
      "type": "result_parse",
      "name": "结果解析",
      "config": {
        "parse_type": "case"
      }
    },
    {
      "id": "output_1",
      "type": "case_save",
      "name": "用例保存",
      "config": {}
    }
  ],
  "edges": [
    { "source": "input_1", "target": "process_1" },
    { "source": "process_1", "target": "process_2" },
    { "source": "process_2", "target": "process_3" },
    { "source": "process_3", "target": "process_4" },
    { "source": "process_4", "target": "process_5" },
    { "source": "process_5", "target": "output_1" }
  ]
}
```

## 五、使用说明

### 5.1 创建工作流

通过 `/v1/workflows` API创建工作流定义，workflow_config字段包含上述JSON结构。

### 5.2 执行工作流

通过 `/api/v1/workflow/execute` API执行工作流，传入workflow_config和input_data。

### 5.3 前端编辑器

访问 `/workflow` 路由，使用可视化编辑器创建工作流。

**注意**: 当前编辑器为基础版本，需要安装vue-flow依赖才能使用完整功能。

安装命令：
```bash
cd frontend
npm install @vue-flow/core @vue-flow/background @vue-flow/controls @vue-flow/minimap
```

### 2.7 工作流执行服务 ✅

**文件位置**:
- Service: `backend-java/.../service/WorkflowExecutionService.java`
- Service实现: `backend-java/.../service/impl/WorkflowExecutionServiceImpl.java`
- Controller: `backend-java/.../controller/WorkflowExecutionController.java`

**已实现功能**:
- ✅ 工作流执行（异步执行）
- ✅ 执行记录查询（按ID、工作流ID、状态等）
- ✅ 执行取消功能
- ✅ 执行进度查询

### 2.8 工作流迁移 ✅

**文件位置**:
- `database/init/07_workflow_initial_data.sql` - 默认用例生成工作流

**已实现**:
- ✅ 创建默认用例生成工作流配置
- ✅ 工作流配置包含完整的节点和边定义

## 三、待完成工作

### 3.1 前端可视化编辑器增强 ⏳

**需要完成**:
1. 安装vue-flow依赖：`npm install @vue-flow/core @vue-flow/background @vue-flow/controls @vue-flow/minimap`
2. 集成vue-flow到WorkflowEditor
3. 实现节点组件（使用vue-flow的CustomNode）
4. 实现连线功能（使用vue-flow的Edge）
5. 实现节点配置面板增强
6. 实现工作流保存和加载功能

### 3.2 流程控制增强 ⏳

**需要完成**:
1. 实现条件分支（根据条件选择不同路径）
2. 实现循环节点完整功能
3. 实现并行执行（如果需要）

### 3.3 工作流集成 ⏳

**需要完成**:
1. 在用例生成页面集成工作流选择
2. 在UI脚本生成页面集成工作流选择
3. 支持使用工作流替代硬编码流程

## 四、工作流配置JSON结构示例

```json
{
  "workflow_code": "CASE_GENERATION_V1",
  "workflow_name": "用例生成工作流",
  "nodes": [
    {
      "id": "input_1",
      "type": "requirement_input",
      "name": "需求输入",
      "config": {}
    },
    {
      "id": "process_1",
      "type": "requirement_analysis",
      "name": "需求分析",
      "config": {}
    },
    {
      "id": "process_2",
      "type": "template_select",
      "name": "模板选择",
      "config": {}
    },
    {
      "id": "process_3",
      "type": "prompt_generate",
      "name": "提示词生成",
      "config": {}
    },
    {
      "id": "process_4",
      "type": "llm_call",
      "name": "模型调用",
      "config": {
        "model_code": "DEEPSEEK_CHAT"
      }
    },
    {
      "id": "process_5",
      "type": "result_parse",
      "name": "结果解析",
      "config": {
        "parse_type": "case"
      }
    },
    {
      "id": "output_1",
      "type": "case_save",
      "name": "用例保存",
      "config": {}
    }
  ],
  "edges": [
    { "source": "input_1", "target": "process_1" },
    { "source": "process_1", "target": "process_2" },
    { "source": "process_2", "target": "process_3" },
    { "source": "process_3", "target": "process_4" },
    { "source": "process_4", "target": "process_5" },
    { "source": "process_5", "target": "output_1" }
  ]
}
```

## 五、使用说明

### 5.1 创建工作流

通过 `/v1/workflows` API创建工作流定义，workflow_config字段包含上述JSON结构。

### 5.2 执行工作流

通过 `/v1/workflow-executions/execute` API执行工作流：
```json
{
  "workflowId": 1,
  "inputData": {
    "requirement_text": "测试需求",
    "layer_code": "FUNCTIONAL",
    "method_code": "EQUIVALENCE_CLASS"
  }
}
```

### 5.3 前端编辑器

访问 `/workflow` 路由，使用可视化编辑器创建工作流。

**注意**: 当前编辑器为基础版本，需要安装vue-flow依赖才能使用完整功能。

安装命令：
```bash
cd frontend
npm install @vue-flow/core @vue-flow/background @vue-flow/controls @vue-flow/minimap
```

## 六、下一步计划

1. **安装vue-flow依赖** - 在前端项目中安装vue-flow
2. **增强可视化编辑器** - 集成vue-flow，实现完整的拖拽编辑功能
3. **工作流集成** - 在用例生成和UI脚本生成页面集成工作流选择
4. **测试和优化** - 测试工作流执行，优化性能和用户体验

---

**文档版本**: v1.0  
**创建时间**: 2026-01-26  
**当前进度**: Week 1-7 核心功能已完成，Week 8 测试和文档待完成
