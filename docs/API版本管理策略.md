# API版本管理策略

## 一、概述

本文档定义了测试设计助手系统的API版本管理策略，包括版本命名规则、升级策略、向后兼容机制、API废弃机制等，确保API的稳定性和可维护性。

## 二、版本命名规则

### 2.1 版本格式

API版本采用URL路径版本控制方式，格式为：`/api/v{major}/`

- **major**：主版本号（整数，从1开始）
- 示例：`/api/v1/`, `/api/v2/`

### 2.2 版本号规则

- **主版本号（major）**：当发生不兼容的API变更时递增
  - 不兼容变更包括：
    - 删除或重命名接口
    - 删除或重命名字段
    - 修改字段类型
    - 修改必需参数
    - 修改响应结构

- **次版本号**：在URL路径版本控制中不使用，通过API文档和变更日志记录

## 三、版本升级策略

### 3.1 多版本并存原则

- **同时支持多个版本**：系统同时支持多个API版本，旧版本不会立即废弃
- **新版本部署**：新版本与旧版本并存，客户端可以逐步迁移
- **版本生命周期**：
  - **稳定期**：版本发布后的主要使用期
  - **维护期**：仅修复安全问题和严重bug
  - **废弃期**：提前通知，不再接受新功能请求
  - **终止期**：完全移除，不再提供服务

### 3.2 版本升级流程

1. **新版本开发**
   - 在新版本路径下实现新功能（如 `/api/v2/`）
   - 保持旧版本接口不变（如 `/api/v1/`）

2. **版本发布**
   - 新版本与旧版本并行运行
   - 更新API文档，标注新版本
   - 发布版本升级通知

3. **客户端迁移**
   - 给予客户端充分的迁移时间（通常为3-6个月）
   - 提供迁移指南和示例代码
   - 提供技术支持

4. **旧版本废弃**
   - 提前3个月发布废弃通知
   - 在响应头中添加废弃警告（`Deprecation` header）
   - 更新API文档，标注废弃状态

5. **版本终止**
   - 在废弃期结束后终止旧版本
   - 移除旧版本代码
   - 更新文档

## 四、向后兼容机制

### 4.1 兼容性原则

- **向前兼容**：新版本应该尽可能兼容旧版本的请求格式
- **响应兼容**：新版本响应应包含旧版本的所有字段，新增字段使用可选方式
- **参数兼容**：新版本接口应支持旧版本的所有参数，新增参数使用可选方式

### 4.2 兼容性变更

以下变更被视为兼容变更，可在同一版本内进行：

- ✅ **新增可选参数**：不影响现有客户端
- ✅ **新增响应字段**：客户端可选择性使用
- ✅ **新增接口**：不影响现有接口
- ✅ **优化性能**：不影响接口行为
- ✅ **修复bug**：修正错误行为

### 4.3 不兼容变更

以下变更被视为不兼容变更，需要升级主版本号：

- ❌ **删除接口**：需要新版本
- ❌ **删除字段**：需要新版本
- ❌ **重命名字段**：需要新版本
- ❌ **修改字段类型**：需要新版本
- ❌ **修改必需参数**：需要新版本
- ❌ **修改响应结构**：需要新版本

## 五、API废弃机制

### 5.1 废弃通知

当API接口或字段即将被废弃时，采用以下通知机制：

1. **响应头通知**：在HTTP响应头中添加废弃信息
   ```
   Deprecation: true
   Sunset: <timestamp>  # 废弃时间戳（RFC 8594）
   Link: <https://api.example.com/docs/v2/migration>; rel="deprecation"
   ```

2. **文档标注**：在API文档中明确标注废弃状态和迁移指南

3. **变更日志**：在API变更日志中记录废弃信息

4. **邮件/公告通知**：提前通知所有使用该接口的客户端

### 5.2 废弃时间表

- **通知期**：提前3个月发布废弃通知
- **废弃期**：接口标记为废弃，但仍可正常使用（3-6个月）
- **终止期**：完全移除接口（废弃期结束后）

### 5.3 废弃示例

```http
# 废弃的接口响应头示例
HTTP/1.1 200 OK
Deprecation: true
Sunset: Sat, 31 Dec 2024 23:59:59 GMT
Link: <https://api.example.com/docs/v2/migration>; rel="deprecation"
```

## 六、响应头规范

### 6.1 标准响应头

所有API响应应包含以下标准响应头：

- **API-Version**：当前API版本号（如：`v1`）
- **X-Request-ID**：请求ID（用于追踪）
- **X-Response-Time**：响应时间（毫秒）

### 6.2 废弃响应头

废弃的API应包含以下响应头：

- **Deprecation**：`true` 表示接口已废弃
- **Sunset**：废弃时间（RFC 8594格式）
- **Link**：迁移指南链接

### 6.3 响应头示例

```http
# 正常接口
HTTP/1.1 200 OK
API-Version: v1
X-Request-ID: abc123
X-Response-Time: 45

# 废弃接口
HTTP/1.1 200 OK
API-Version: v1
Deprecation: true
Sunset: Sat, 31 Dec 2024 23:59:59 GMT
Link: <https://api.example.com/docs/v2/migration>; rel="deprecation"
```

## 七、版本迁移指南

### 7.1 迁移步骤

1. **评估影响**：分析当前使用的API接口，确定需要迁移的接口
2. **查看文档**：阅读新版本API文档和迁移指南
3. **开发测试**：在新版本路径下进行开发和测试
4. **逐步迁移**：按模块逐步迁移，确保功能正常
5. **验证测试**：进行全面测试，确保功能正确
6. **切换版本**：切换到新版本，监控运行状态
7. **清理代码**：移除旧版本代码

### 7.2 迁移检查清单

- [ ] 已阅读新版本API文档
- [ ] 已了解接口变更内容
- [ ] 已更新请求参数
- [ ] 已更新响应处理逻辑
- [ ] 已进行功能测试
- [ ] 已进行兼容性测试
- [ ] 已更新错误处理逻辑
- [ ] 已更新文档和注释

## 八、当前版本状态

### 8.1 当前版本

- **v1**：当前稳定版本（2024-01-01发布）
  - 状态：稳定期
  - 支持：完整功能支持
  - 维护：持续维护和bug修复

### 8.2 版本历史

详见 [API变更日志](./API变更日志.md)

## 九、最佳实践

### 9.1 开发建议

1. **设计时考虑扩展性**：接口设计时考虑未来扩展，使用可选参数和字段
2. **文档先行**：新接口开发前先编写API文档
3. **版本标记**：所有接口明确标注版本号
4. **测试覆盖**：确保版本兼容性测试覆盖

### 9.2 使用建议

1. **固定版本**：客户端应固定使用特定版本，避免自动升级
2. **监控废弃通知**：定期检查API文档和变更日志
3. **及时迁移**：收到废弃通知后及时规划迁移
4. **测试验证**：迁移前进行充分测试

## 十、联系与支持

- **API文档**：http://localhost:8080/api/swagger-ui.html
- **变更日志**：`docs/API变更日志.md`
- **技术支持**：联系开发团队

---

**文档版本**：v1.0  
**最后更新**：2024-01-01  
**维护人员**：测试设计助手系统开发团队

