# 测试设计助手系统 - 日志规范文档

## 一、概述

本文档定义了测试设计助手系统的日志规范，包括日志级别、格式、内容要求等，旨在统一日志记录标准，提升问题排查效率和安全审计能力。

## 二、日志级别

### 2.1 日志级别定义

系统使用以下日志级别（按严重程度从低到高）：

1. **TRACE**：详细的程序执行轨迹，用于调试
   - 使用场景：方法进入/退出、变量值输出等
   - 生产环境：关闭

2. **DEBUG**：调试信息，用于开发调试
   - 使用场景：关键变量值、中间结果、流程节点等
   - 生产环境：关闭或仅关键模块开启

3. **INFO**：一般信息，记录程序正常运行的关键信息
   - 使用场景：业务操作开始/结束、重要状态变更、配置加载等
   - 生产环境：开启

4. **WARN**：警告信息，表示潜在问题但不影响系统运行
   - 使用场景：降级操作、重试操作、配置缺失但使用默认值等
   - 生产环境：开启

5. **ERROR**：错误信息，表示错误但不影响系统继续运行
   - 使用场景：业务异常、外部服务调用失败、数据校验失败等
   - 生产环境：开启

6. **FATAL**：致命错误，可能导致系统无法继续运行
   - 使用场景：系统崩溃、数据库连接失败、关键组件初始化失败等
   - 生产环境：开启

### 2.2 日志级别使用原则

- **TRACE/DEBUG**：仅在开发和测试环境使用
- **INFO**：记录关键业务流程和状态变更
- **WARN**：记录异常但可恢复的情况
- **ERROR**：记录错误但系统可继续运行
- **FATAL**：记录致命错误，需要立即处理

## 三、日志格式

### 3.1 标准日志格式

```
%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [traceId=%X{traceId}] [userId=%X{userId}] %msg%n
```

### 3.2 格式说明

- **时间戳**：`yyyy-MM-dd HH:mm:ss.SSS`，精确到毫秒
- **线程名**：`%thread`，记录执行线程
- **日志级别**：`%-5level`，左对齐，5个字符宽度
- **Logger名称**：`%logger{36}`，最多36个字符
- **TraceId**：`%X{traceId}`，请求追踪ID（MDC）
- **UserId**：`%X{userId}`，用户ID（MDC）
- **消息内容**：`%msg`，日志消息
- **换行符**：`%n`

### 3.3 日志格式示例

```
2024-01-01 10:30:45.123 [http-nio-8080-exec-1] INFO  c.s.t.s.i.RequirementServiceImpl - [traceId=abc123] [userId=1001] 创建需求成功: requirementId=1, requirementCode=REQ-20240101-001
```

## 四、日志内容要求

### 4.1 日志消息结构

日志消息应包含以下信息（按重要性排序）：

1. **操作描述**：清晰描述执行的操作
2. **关键参数**：记录关键输入参数
3. **操作结果**：记录操作结果（成功/失败）
4. **异常信息**：如果失败，记录异常信息

### 4.2 日志消息模板

#### 4.2.1 操作开始日志

```java
log.info("开始执行操作: operation={}, params={}", operation, params);
```

#### 4.2.2 操作成功日志

```java
log.info("操作成功: operation={}, result={}, executionTime={}ms", operation, result, executionTime);
```

#### 4.2.3 操作失败日志

```java
log.error("操作失败: operation={}, params={}, error={}", operation, params, e.getMessage(), e);
```

#### 4.2.4 警告日志

```java
log.warn("警告信息: message={}, reason={}", message, reason);
```

### 4.3 日志内容规范

1. **使用中文描述**：日志消息使用中文，便于阅读
2. **避免敏感信息**：不记录密码、API密钥等敏感信息
3. **结构化数据**：关键数据使用JSON格式或键值对格式
4. **避免过长**：单条日志消息不超过1000字符
5. **包含上下文**：记录足够的上下文信息，便于问题定位

## 五、关键操作日志

### 5.1 业务操作日志

以下业务操作必须记录日志：

#### 5.1.1 需求管理

- 创建需求：`log.info("创建需求: requirementId={}, requirementCode={}", id, code)`
- 更新需求：`log.info("更新需求: requirementId={}, changes={}", id, changes)`
- 删除需求：`log.warn("删除需求: requirementId={}", id)`
- 状态流转：`log.info("需求状态流转: requirementId={}, from={}, to={}", id, from, to)`

#### 5.1.2 用例管理

- 创建用例：`log.info("创建用例: caseId={}, caseCode={}", id, code)`
- 更新用例：`log.info("更新用例: caseId={}, changes={}", id, changes)`
- 删除用例：`log.warn("删除用例: caseId={}", id)`
- 审核用例：`log.info("审核用例: caseId={}, result={}", id, result)`
- 状态流转：`log.info("用例状态流转: caseId={}, from={}, to={}", id, from, to)`

#### 5.1.3 用例生成

- 创建生成任务：`log.info("创建用例生成任务: taskId={}, taskCode={}", id, code)`
- 开始生成：`log.info("开始生成用例: taskId={}, requirementId={}", taskId, requirementId)`
- 生成成功：`log.info("用例生成成功: taskId={}, successCount={}, failCount={}", taskId, success, fail)`
- 生成失败：`log.error("用例生成失败: taskId={}, error={}", taskId, error)`

#### 5.1.4 外部服务调用

- 调用AI服务：`log.info("调用AI服务: url={}, request={}", url, request)`
- 调用成功：`log.info("AI服务调用成功: url={}, responseTime={}ms", url, time)`
- 调用失败：`log.error("AI服务调用失败: url={}, error={}", url, error)`

### 5.2 系统操作日志

以下系统操作必须记录日志：

- 系统启动：`log.info("系统启动成功: version={}, port={}", version, port)`
- 系统关闭：`log.info("系统关闭: reason={}", reason)`
- 配置加载：`log.info("加载配置: config={}", config)`
- 数据库连接：`log.info("数据库连接成功/失败: status={}", status)`
- Redis连接：`log.info("Redis连接成功/失败: status={}", status)`

## 六、审计日志

### 6.1 审计日志记录

审计日志通过AOP切面自动记录，包含以下信息：

- 用户信息（用户ID、用户名）
- 操作类型（CREATE/UPDATE/DELETE/APPROVE/QUERY等）
- 操作模块（REQUIREMENT/CASE/TEMPLATE等）
- 操作目标（实体ID或名称）
- 操作内容（方法名和参数）
- 操作结果（SUCCESS/FAILURE）
- 错误信息（如果失败）
- IP地址
- 用户代理
- 请求URL和方法
- 请求参数
- 响应状态码
- 执行时间

### 6.2 审计日志查询

审计日志可通过`AuditLogService`查询：

```java
// 根据用户ID查询
List<AuditLog> logs = auditLogService.findByUserId(userId);

// 根据操作类型查询
List<AuditLog> logs = auditLogService.findByOperationType("CREATE");

// 根据时间范围查询
List<AuditLog> logs = auditLogService.findByTimeRange(startTime, endTime);
```

## 七、日志配置

### 7.1 日志配置文件

日志配置在`application.yml`中：

```yaml
logging:
  level:
    root: INFO
    com.sinosoft.testdesign: DEBUG
  pattern:
    # 控制台日志格式：包含traceId和userId
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [traceId=%X{traceId}] [userId=%X{userId}] %msg%n"
    # 文件日志格式：包含traceId和userId
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [traceId=%X{traceId}] [userId=%X{userId}] %msg%n"
  # 日志文件配置（生产环境建议启用）
  file:
    name: logs/test-design-assistant.log
    max-size: 100MB
    max-history: 30
```

### 7.2 MDC过滤器配置

系统已实现`LoggingMDCFilter`过滤器（位于`com.sinosoft.testdesign.config`包），自动为每个HTTP请求设置MDC上下文：

**功能说明**：
- 自动生成或从请求头获取`traceId`（请求头：`X-Trace-Id`）
- 自动从请求头获取`userId`（请求头：`X-User-Id`，如果不存在则默认为"anonymous"）
- 请求结束后自动清除MDC，避免内存泄漏

**实现位置**：
- `backend-java/test-design-assistant-core/src/main/java/com/sinosoft/testdesign/config/LoggingMDCFilter.java`

**使用方式**：
- 过滤器已通过`@Component`注解自动注册，无需额外配置
- 所有HTTP请求会自动设置traceId和userId到MDC
- 日志输出时会自动包含traceId和userId信息

## 八、最佳实践

### 8.1 日志记录原则

1. **及时记录**：关键操作立即记录，不延迟
2. **准确记录**：记录真实情况，不夸大或缩小
3. **完整记录**：包含足够的上下文信息
4. **安全记录**：不记录敏感信息
5. **性能考虑**：避免在高频操作中记录过多日志

### 8.2 日志使用建议

1. **使用合适的日志级别**：根据严重程度选择合适的级别
2. **使用占位符**：使用`{}`占位符，避免字符串拼接
3. **记录异常堆栈**：错误日志包含异常堆栈信息
4. **记录执行时间**：关键操作记录执行时间
5. **使用MDC**：使用MDC记录traceId、userId等上下文信息

### 8.3 MDC使用

系统已实现`LoggingMDCFilter`过滤器，自动为每个请求设置traceId和userId到MDC：

- **traceId**：自动生成UUID（如果请求头`X-Trace-Id`不存在），用于请求追踪
- **userId**：从请求头`X-User-Id`获取（如果不存在则默认为"anonymous"）

**使用方式**：
- 开发人员无需手动设置MDC，过滤器会自动处理
- 日志格式中已包含traceId和userId，会自动输出
- 如果需要在代码中获取traceId或userId，可以使用：
  ```java
  String traceId = MDC.get("traceId");
  String userId = MDC.get("userId");
  ```

**注意事项**：
- MDC在请求结束后会自动清除，避免内存泄漏
- 如果需要在异步线程中使用MDC，需要手动传递MDC上下文

### 8.4 日志示例

```java
// 好的示例
log.info("创建需求成功: requirementId={}, requirementCode={}, executionTime={}ms", 
    id, code, executionTime);

// 不好的示例
log.info("创建需求成功"); // 缺少关键信息
log.info("创建需求成功: " + id); // 使用字符串拼接
```

## 九、日志监控

### 9.1 日志监控指标

建议监控以下日志指标：

- 错误日志数量（ERROR级别）
- 警告日志数量（WARN级别）
- 日志生成速率
- 日志文件大小
- 异常堆栈出现频率

### 9.2 日志告警

建议配置以下告警规则：

- 错误日志数量超过阈值
- 特定错误频繁出现
- 日志文件大小异常增长
- 系统关键组件错误

## 十、总结

本文档定义了测试设计助手系统的日志规范，包括日志级别、格式、内容要求等。开发人员应遵循本规范记录日志，确保日志的一致性和可读性，提升问题排查效率和安全审计能力。

---

**文档版本**：v1.0  
**最后更新**：2024-01-01  
**适用项目**：测试设计助手系统

