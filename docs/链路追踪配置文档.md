# 链路追踪配置文档

## 一、概述

本文档说明测试设计助手系统的分布式链路追踪功能，使用Spring Cloud Sleuth + Zipkin实现请求全链路追踪。

## 二、技术方案

### 2.1 技术选型

- **链路追踪框架**: Spring Cloud Sleuth
- **追踪数据收集**: Micrometer Tracing (Brave)
- **追踪数据存储和展示**: Zipkin

### 2.2 架构说明

```
请求 → Spring Boot应用 → Sleuth自动追踪 → Zipkin收集 → Zipkin UI展示
```

## 三、配置说明

### 3.1 依赖配置

在`pom.xml`中添加以下依赖：

```xml
<!-- Spring Cloud Sleuth (链路追踪) -->
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-tracing-bridge-brave</artifactId>
</dependency>
<dependency>
    <groupId>io.zipkin.reporter2</groupId>
    <artifactId>zipkin-reporter-brave</artifactId>
</dependency>
```

### 3.2 应用配置

在`application.yml`中配置：

```yaml
# Spring Cloud Sleuth配置（链路追踪）
management:
  tracing:
    sampling:
      probability: 1.0  # 采样率：100%（生产环境建议根据实际情况调整）
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans  # Zipkin服务地址
```

### 3.3 Docker配置

在`docker-compose.yml`中添加Zipkin服务：

```yaml
zipkin:
  image: openzipkin/zipkin:latest
  container_name: test-design-zipkin
  ports:
    - "9411:9411"
  environment:
    - STORAGE_TYPE=mem  # 使用内存存储（生产环境建议使用Elasticsearch）
  networks:
    - test-design-network
```

## 四、追踪范围

### 4.1 自动追踪

Sleuth自动追踪以下操作：

1. **HTTP请求**: 所有Controller层的HTTP请求
2. **数据库查询**: JPA/Hibernate的数据库查询
3. **Redis操作**: Spring Data Redis的操作
4. **外部服务调用**: RestTemplate的HTTP调用（如AI服务调用）

### 4.2 追踪信息

每个追踪包含以下信息：

- **Trace ID**: 追踪ID（整个请求链路共享）
- **Span ID**: 跨度ID（每个操作一个）
- **Parent Span ID**: 父跨度ID（用于构建调用树）
- **操作名称**: 操作类型（如：HTTP请求、数据库查询等）
- **时间戳**: 开始时间和结束时间
- **标签**: 附加信息（如：HTTP方法、URL、状态码等）

## 五、使用方式

### 5.1 访问Zipkin UI

启动服务后，访问Zipkin UI：

- **URL**: http://localhost:9411
- **功能**: 
  - 查看追踪列表
  - 搜索追踪
  - 查看追踪详情
  - 查看服务依赖关系

### 5.2 搜索追踪

在Zipkin UI中可以按以下条件搜索：

- **服务名称**: test-design-assistant-core
- **追踪ID**: 完整的Trace ID
- **时间范围**: 选择时间范围
- **标签**: 如HTTP方法、状态码等

### 5.3 查看追踪详情

点击追踪列表中的任意追踪，可以查看：

- **时间线**: 显示各个操作的执行顺序和耗时
- **调用树**: 显示服务调用关系
- **标签信息**: 显示每个操作的详细信息

## 六、生产环境配置

### 6.1 采样率调整

生产环境建议根据实际情况调整采样率：

```yaml
management:
  tracing:
    sampling:
      probability: 0.1  # 10%采样率（根据实际情况调整）
```

### 6.2 存储配置

生产环境建议使用Elasticsearch存储追踪数据：

```yaml
zipkin:
  image: openzipkin/zipkin:latest
  environment:
    - STORAGE_TYPE=elasticsearch
    - ES_HOSTS=http://elasticsearch:9200
    - ES_INDEX=zipkin
```

### 6.3 性能优化

1. **采样率**: 根据系统负载调整采样率，避免过多追踪数据
2. **存储**: 使用Elasticsearch等持久化存储，避免内存溢出
3. **保留策略**: 配置数据保留时间，定期清理旧数据

## 七、常见问题

### 7.1 追踪数据不显示

**问题**: Zipkin UI中看不到追踪数据

**解决方案**:
1. 检查Zipkin服务是否正常运行
2. 检查应用配置中的Zipkin端点是否正确
3. 检查网络连接是否正常
4. 检查采样率配置（如果为0，则不会追踪）

### 7.2 追踪数据过多

**问题**: 追踪数据过多，影响性能

**解决方案**:
1. 降低采样率
2. 只追踪关键操作
3. 使用异步追踪

### 7.3 追踪数据丢失

**问题**: 部分追踪数据丢失

**解决方案**:
1. 检查Zipkin存储配置
2. 检查网络连接
3. 使用持久化存储（如Elasticsearch）

## 八、最佳实践

1. **采样率**: 生产环境建议使用10-50%的采样率
2. **存储**: 使用Elasticsearch等持久化存储
3. **监控**: 监控Zipkin服务状态和存储使用情况
4. **清理**: 定期清理旧数据，避免存储空间不足
5. **告警**: 配置追踪数据异常告警

## 九、服务依赖关系

Zipkin可以自动生成服务依赖关系图，显示：

- 服务之间的调用关系
- 调用频率
- 调用耗时

可以通过Zipkin UI的"Dependencies"页面查看。

## 十、与监控系统集成

链路追踪可以与监控系统集成：

1. **Grafana**: 可以集成Zipkin数据源，在Grafana中查看追踪数据
2. **Prometheus**: 可以导出追踪指标到Prometheus
3. **告警**: 可以根据追踪数据配置告警规则

---

**文档版本**: 1.0  
**更新日期**: 2024-01-13  
**维护人**: 系统开发团队

