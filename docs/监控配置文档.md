# 监控配置文档

## 一、概述

本文档说明测试设计助手系统的监控配置，包括Prometheus指标收集、Grafana可视化展示和AlertManager告警配置。

## 二、监控架构

### 2.1 组件说明

- **Prometheus**: 指标收集和存储系统
- **Grafana**: 监控数据可视化平台
- **AlertManager**: 告警管理和通知系统
- **Spring Boot Actuator**: 应用指标暴露端点

### 2.2 监控流程

```
应用服务 → Spring Boot Actuator → Prometheus → Grafana (可视化)
                                      ↓
                                 AlertManager (告警)
```

## 三、Prometheus配置

### 3.1 配置文件位置

- 主配置文件: `monitoring/prometheus/prometheus.yml`
- 告警规则: `monitoring/prometheus/alerts/*.rules.yml`

### 3.2 监控目标

- **backend-java**: `http://backend-java:8080/actuator/prometheus`
- **backend-python**: `http://backend-python:8000` (如果后续添加Prometheus支持)

### 3.3 告警规则

#### 3.3.1 系统资源告警 (`system.rules.yml`)

- **JVM堆内存使用率**: > 80% (警告), > 90% (严重)
- **GC耗时**: > 1秒 (警告), > 5秒 (严重)
- **线程数**: > 500 (警告)
- **CPU使用率**: > 80% (警告), > 90% (严重)
- **内存使用率**: > 85% (警告), > 95% (严重)

#### 3.3.2 应用告警 (`application.rules.yml`)

- **接口错误率**: > 5% (警告), > 10% (严重)
- **接口响应时间**: > 3秒 (警告), > 10秒 (严重)
- **接口QPS突增**: > 200% (警告)
- **数据库连接池使用率**: > 80% (警告), > 90% (严重)
- **Redis连接失败**: 严重
- **Redis内存使用率**: > 80% (警告)

#### 3.3.3 业务告警 (`business.rules.yml`)

- **用例生成失败率**: > 10% (警告), > 20% (严重)
- **用例生成任务积压**: > 100个 (警告)
- **用例生成平均耗时**: > 60秒 (警告)
- **模型调用失败率**: > 5% (警告), > 10% (严重)
- **模型调用超时**: > 10次/小时 (警告)
- **模型调用Token使用量突增**: > 200% (警告)

#### 3.3.4 健康检查告警 (`health.rules.yml`)

- **服务健康检查失败**: 严重
- **数据库连接失败**: 严重
- **Redis连接失败**: 严重
- **AI服务连接失败**: 警告

## 四、Grafana配置

### 4.1 访问地址

- URL: `http://localhost:3001`
- 默认用户名: `admin`
- 默认密码: `admin` (首次登录后建议修改)

### 4.2 Dashboard列表

#### 4.2.1 系统资源监控 (`system-resources.json`)

监控指标：
- JVM堆内存使用率
- JVM非堆内存使用率
- GC次数和耗时
- 线程数
- CPU使用率
- 内存使用率
- 文件描述符

#### 4.2.2 应用性能监控 (`application-performance.json`)

监控指标：
- 接口响应时间（95分位）
- 接口QPS
- 接口错误率
- 慢接口Top 10
- 数据库连接池使用率
- 数据库查询耗时
- Redis连接数和内存使用率

#### 4.2.3 业务监控 (`business-metrics.json`)

监控指标：
- 用例生成任务总数
- 用例生成成功率
- 用例生成平均耗时
- 用例生成失败原因分布
- 模型调用次数
- 模型调用成功率
- 模型调用平均耗时
- 模型调用Token使用量
- 各模型调用分布

### 4.3 Dashboard导入

Dashboard配置文件位于 `monitoring/grafana/dashboards/` 目录，Grafana启动后会自动加载。

手动导入步骤：
1. 登录Grafana
2. 点击左侧菜单 "Dashboards" → "Import"
3. 选择对应的JSON文件或粘贴JSON内容
4. 选择Prometheus数据源
5. 点击 "Import"

## 五、AlertManager配置

### 5.1 配置文件位置

- 主配置文件: `monitoring/alertmanager/alertmanager.yml`

### 5.2 告警路由

- **严重告警** (`severity: critical`): 发送到 `critical-receiver`
- **警告告警** (`severity: warning`): 发送到 `warning-receiver`
- **默认告警**: 发送到 `default-receiver`

### 5.3 通知渠道配置

当前配置使用Webhook作为默认通知渠道。实际使用时需要配置真实的通知渠道：

#### 5.3.1 邮件通知

```yaml
email_configs:
  - to: 'ops-team@example.com'
    subject: '严重告警: {{ .GroupLabels.alertname }}'
    html: '{{ range .Alerts }}{{ .Annotations.description }}<br>{{ end }}'
```

需要配置SMTP服务器：
```yaml
global:
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@example.com'
  smtp_auth_username: 'alertmanager@example.com'
  smtp_auth_password: 'password'
```

#### 5.3.2 企业微信通知

```yaml
wechat_configs:
  - api_url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY'
    message: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
```

#### 5.3.3 钉钉通知

```yaml
webhook_configs:
  - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN'
    send_resolved: true
```

## 六、健康检查配置

### 6.1 Java后端服务

- **存活检查**: `http://localhost:8080/actuator/health/liveness`
- **就绪检查**: `http://localhost:8080/actuator/health/readiness`
- **Docker健康检查**: 每30秒检查一次，超时3秒，启动等待40秒

### 6.2 Python AI服务

- **健康检查**: `http://localhost:8000/health`
- **Docker健康检查**: 每30秒检查一次，超时3秒，启动等待20秒

### 6.3 数据库和Redis

- **PostgreSQL**: 使用 `pg_isready` 命令检查
- **Redis**: 使用 `redis-cli ping` 命令检查

## 七、部署和使用

### 7.1 启动监控服务

```bash
# 启动所有服务（包括监控服务）
docker-compose up -d

# 仅启动监控服务
docker-compose up -d prometheus grafana alertmanager
```

### 7.2 访问地址

- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3001
- **AlertManager**: http://localhost:9093

### 7.3 验证配置

1. **验证Prometheus抓取**:
   - 访问 http://localhost:9090/targets
   - 检查所有targets状态为 "UP"

2. **验证Grafana数据源**:
   - 登录Grafana
   - 进入 "Configuration" → "Data Sources"
   - 检查Prometheus数据源状态为 "Healthy"

3. **验证告警规则**:
   - 访问 http://localhost:9090/alerts
   - 检查告警规则已加载

4. **验证健康检查**:
   ```bash
   # 检查容器健康状态
   docker-compose ps
   # 应该看到所有服务的健康状态为 "healthy"
   ```

## 八、监控指标说明

### 8.1 JVM指标

- `jvm_memory_used_bytes`: JVM内存使用量（按区域：heap、nonheap）
- `jvm_memory_max_bytes`: JVM最大内存（按区域）
- `jvm_gc_pause_seconds_count`: GC次数
- `jvm_gc_pause_seconds_sum`: GC总耗时
- `jvm_threads_live_threads`: 活跃线程数

### 8.2 系统指标

- `system_cpu_usage`: CPU使用率
- `process_files_open`: 打开文件数

### 8.3 HTTP指标

- `http_server_requests_seconds_count`: HTTP请求总数
- `http_server_requests_seconds_bucket`: HTTP请求耗时分布（直方图）
- `http_server_requests_seconds_sum`: HTTP请求总耗时

### 8.4 数据库指标

- `hikari_connections_active`: 活跃连接数
- `hikari_connections_max`: 最大连接数
- `jdbc_connections_idle`: 空闲连接数
- `jdbc_connections_active`: 活跃连接数

### 8.5 业务指标（需要自定义实现）

- `case_generation_task_total`: 用例生成任务总数
- `case_generation_task_duration_seconds`: 用例生成耗时
- `llm_call_total`: 模型调用总数
- `llm_call_duration_seconds`: 模型调用耗时
- `llm_tokens_used_total`: 模型调用Token使用量

**注意**: 业务指标需要在应用代码中使用Micrometer进行收集，详见"业务指标监控实现"任务。

## 九、常见问题

### 9.1 Prometheus无法抓取指标

**问题**: Prometheus targets显示为 "DOWN"

**解决方案**:
1. 检查应用服务是否正常运行
2. 检查网络连接（确保在同一个Docker网络）
3. 检查Actuator端点是否可访问: `curl http://backend-java:8080/actuator/prometheus`
4. 检查Prometheus配置中的targets地址是否正确

### 9.2 Grafana无法显示数据

**问题**: Dashboard显示 "No data"

**解决方案**:
1. 检查Prometheus数据源配置是否正确
2. 检查Prometheus中是否有数据: 访问 http://localhost:9090/graph 查询指标
3. 检查时间范围设置是否正确
4. 检查Dashboard中的PromQL查询语句是否正确

### 9.3 告警未触发

**问题**: 告警规则配置了但未触发

**解决方案**:
1. 检查Prometheus中告警规则是否加载: 访问 http://localhost:9090/alerts
2. 检查告警条件是否满足（可能需要等待一段时间）
3. 检查AlertManager配置是否正确
4. 检查通知渠道配置是否正确

### 9.4 健康检查失败

**问题**: Docker容器健康检查失败

**解决方案**:
1. 检查应用服务是否正常启动
2. 检查健康检查端点是否可访问
3. 检查健康检查命令是否正确
4. 查看容器日志: `docker-compose logs <service-name>`

## 十、最佳实践

1. **定期检查告警规则**: 确保告警阈值设置合理
2. **监控Dashboard优化**: 根据实际需求调整Dashboard面板
3. **告警通知优化**: 配置合适的通知渠道，避免告警疲劳
4. **指标保留时间**: 根据存储容量调整Prometheus数据保留时间
5. **性能优化**: 对于高并发场景，考虑使用Prometheus Federation或Thanos
6. **安全配置**: 生产环境建议配置Grafana和Prometheus的认证和授权

## 十一、后续优化

1. **业务指标收集**: 实现自定义业务指标收集（用例生成、模型调用等）
2. **链路追踪**: 集成分布式链路追踪系统（Sleuth/Zipkin或Jaeger）
3. **日志聚合**: 集成ELK或Loki进行日志聚合和分析
4. **告警优化**: 配置更丰富的告警通知渠道（邮件、企业微信、钉钉等）
5. **Dashboard扩展**: 根据业务需求创建更多Dashboard

---

**文档版本**: 1.0  
**更新日期**: 2024-01-13  
**维护人**: 开发团队

