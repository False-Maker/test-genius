# 框架升级说明

## 升级概述

本次升级将 FastAPI 和 LangChain 框架升级到最新版本，以获取更好的性能、安全性和功能支持。

## 升级内容

### 1. FastAPI 升级

**升级前版本**: `0.104.1`  
**升级后版本**: `0.115.0`

**相关依赖升级**:
- `uvicorn[standard]`: `0.24.0` → `0.32.0`
- `pydantic`: `2.5.0` → `2.9.0`
- `pydantic-settings`: `2.1.0` → `2.5.0`

**主要变更**:
- 性能优化和 bug 修复
- 更好的类型提示支持
- 改进的文档生成

### 2. LangChain 升级

**升级前版本**: `0.1.0`  
**升级后版本**: `0.3.0`

**相关依赖升级**:
- `langchain-core`: `0.3.0` (新增，核心功能)
- `langchain`: `0.3.0`
- `langchain-community`: `0.0.10` → `0.3.0`
- `langchain-openai`: `0.0.5` → `0.2.0`
- `openai`: `1.3.0` → `1.54.0`

**主要变更**:
- **重大变更**: LangChain 0.3.x 使用新的消息格式（Message 对象）
- 模型调用方式从字符串改为 Message 对象列表
- API 参数名称变更（如 `openai_api_base` → `base_url`）
- 更好的类型安全和错误处理

### 3. 其他依赖升级

- `httpx`: `0.25.2` → `0.27.0`
- `requests`: `2.31.0` → `2.32.0`
- `python-dotenv`: `1.0.0` → `1.0.1`
- `python-multipart`: `0.0.6` → `0.0.9`
- `python-docx`: `1.1.0` → `1.1.2`

## 代码兼容性修改

### 1. LangChain 模型调用方式变更

**旧版本 (0.1.x)**:
```python
response = llm.invoke(prompt)  # 直接传入字符串
```

**新版本 (0.3.x)**:
```python
from langchain_core.messages import HumanMessage
messages = [HumanMessage(content=prompt)]
response = llm.invoke(messages)  # 使用 Message 对象列表
```

**兼容性处理**:
代码中已添加兼容性处理，自动检测版本并选择合适的调用方式。

### 2. ChatOpenAI 参数变更

**旧版本**:
```python
ChatOpenAI(
    openai_api_key=api_key,
    openai_api_base=api_endpoint,
    ...
)
```

**新版本**:
```python
ChatOpenAI(
    api_key=api_key,
    base_url=api_endpoint,  # 参数名变更
    ...
)
```

**兼容性处理**:
代码中已添加 try-except 处理，自动适配新旧版本 API。

### 3. 响应对象处理

**变更**:
- 新版本返回 `AIMessage` 对象，需要提取 `content` 属性
- 代码中已添加多种提取方式的兼容性处理

## 关于 langchainsdk

**不需要安装 `langchainsdk`**。

`langchainsdk` 是 LangSmith SDK，用于 LangChain 的监控和追踪功能，不是核心依赖。如果未来需要使用 LangSmith 进行模型调用监控，可以单独安装：

```bash
pip install langsmith
```

## 升级步骤

### 1. 备份当前环境

```bash
# 备份当前依赖
pip freeze > requirements_backup.txt
```

### 2. 升级依赖

```bash
cd backend-python/ai-service
pip install -r requirements.txt --upgrade
```

### 3. 验证安装

```bash
# 检查版本
python -c "import fastapi; print(fastapi.__version__)"
python -c "import langchain; print(langchain.__version__)"
```

### 4. 测试功能

```bash
# 启动服务
python -m uvicorn app.main:app --reload

# 测试 API
curl http://localhost:8000/health
curl http://localhost:8000/api/v1/llm/call
```

## 可能遇到的问题

### 1. 导入错误

如果遇到 `ImportError: cannot import name 'ChatOpenAI'`，请检查：
- `langchain-openai` 是否正确安装
- Python 版本是否为 3.10+

### 2. API 参数错误

如果遇到参数错误，代码已包含兼容性处理，会自动降级到旧版本 API。

### 3. 消息格式错误

如果模型调用失败，检查是否正确使用 `HumanMessage` 对象。

## 回滚方案

如果升级后出现问题，可以回滚到旧版本：

```bash
pip install fastapi==0.104.1
pip install langchain==0.1.0 langchain-community==0.0.10 langchain-openai==0.0.5
```

## 测试清单

升级后请测试以下功能：

- [ ] FastAPI 服务正常启动
- [ ] 健康检查接口正常
- [ ] 大模型调用接口正常
- [ ] DeepSeek 模型调用正常
- [ ] 豆包模型调用正常
- [ ] Kimi 模型调用正常
- [ ] 通义千问模型调用正常
- [ ] 批量调用功能正常
- [ ] 错误处理和重试机制正常

## 参考文档

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [LangChain 官方文档](https://docs.langchain.com/)
- [LangChain 0.3 迁移指南](https://docs.langchain.com/docs/versions/v0_3/)

## 更新日期

2024-01-XX

