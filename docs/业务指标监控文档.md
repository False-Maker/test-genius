# 业务指标监控文档

## 一、概述

本文档说明测试设计助手系统的业务指标监控功能，包括指标定义、收集方式、查询方法和告警阈值建议。

## 二、指标定义

### 2.1 用例生成任务指标

#### case_generation_task_total
- **类型**: Counter（计数器）
- **描述**: 用例生成任务总数
- **标签**: 
  - `type`: task
- **用途**: 统计用例生成任务的总数

#### case_generation_task_success
- **类型**: Counter（计数器）
- **描述**: 用例生成任务成功数
- **标签**: 
  - `type`: task
- **用途**: 统计成功完成的用例生成任务数

#### case_generation_task_failed
- **类型**: Counter（计数器）
- **描述**: 用例生成任务失败数
- **标签**: 
  - `type`: task
  - `reason`: 失败原因（如：BusinessException、TimeoutException等）
- **用途**: 统计失败的用例生成任务数，按失败原因分类

#### case_generation_task_duration_seconds
- **类型**: Timer（计时器）
- **描述**: 用例生成任务耗时（秒）
- **用途**: 统计用例生成任务的执行时间分布

#### case_generation_task_queue_length
- **类型**: Gauge（仪表盘）
- **描述**: 用例生成任务队列长度
- **用途**: 实时监控待处理的任务数量

### 2.2 模型调用指标

#### llm_call_total
- **类型**: Counter（计数器）
- **描述**: 模型调用总数
- **标签**: 
  - `type`: llm
  - `model`: 模型代码（如：deepseek-chat、doubao-pro等）
- **用途**: 统计模型调用的总数，按模型分类

#### llm_call_success
- **类型**: Counter（计数器）
- **描述**: 模型调用成功数
- **标签**: 
  - `type`: llm
  - `model`: 模型代码
- **用途**: 统计成功的模型调用数

#### llm_call_failed
- **类型**: Counter（计数器）
- **描述**: 模型调用失败数
- **标签**: 
  - `type`: llm
  - `model`: 模型代码
  - `reason`: 失败原因
- **用途**: 统计失败的模型调用数，按模型和失败原因分类

#### llm_call_duration_seconds
- **类型**: Timer（计时器）
- **描述**: 模型调用耗时（秒）
- **用途**: 统计模型调用的响应时间分布

#### llm_tokens_used_total
- **类型**: Counter（计数器）
- **描述**: 模型调用Token使用总量
- **标签**: 
  - `type`: llm
  - `model`: 模型代码
- **用途**: 统计Token使用量，用于成本分析

## 三、指标收集方式

### 3.1 Java后端指标收集

指标收集通过`BusinessMetricsCollector`类实现，使用Micrometer框架：

```java
@Autowired
private BusinessMetricsCollector metricsCollector;

// 记录任务创建
metricsCollector.recordCaseGenerationTaskCreated();

// 记录任务成功
metricsCollector.recordCaseGenerationTaskSuccess(durationSeconds);

// 记录任务失败
metricsCollector.recordCaseGenerationTaskFailed(durationSeconds, reason);
```

### 3.2 Python服务指标收集

Python服务通过Prometheus客户端库收集指标，指标通过HTTP端点暴露：

- 端点: `/metrics`
- 格式: Prometheus格式

## 四、指标查询

### 4.1 Prometheus查询示例

#### 用例生成成功率
```promql
rate(case_generation_task_success[5m]) / rate(case_generation_task_total[5m]) * 100
```

#### 用例生成失败率
```promql
rate(case_generation_task_failed[5m]) / rate(case_generation_task_total[5m]) * 100
```

#### 用例生成平均耗时
```promql
rate(case_generation_task_duration_seconds_sum[5m]) / rate(case_generation_task_duration_seconds_count[5m])
```

#### 模型调用成功率
```promql
rate(llm_call_success[5m]) / rate(llm_call_total[5m]) * 100
```

#### 模型调用失败率
```promql
rate(llm_call_failed[5m]) / rate(llm_call_total[5m]) * 100
```

#### 模型调用平均耗时
```promql
rate(llm_call_duration_seconds_sum[5m]) / rate(llm_call_duration_seconds_count[5m])
```

#### 各模型调用分布
```promql
sum by (model) (rate(llm_call_total[5m]))
```

#### Token使用量（按模型）
```promql
sum by (model) (increase(llm_tokens_used_total[1h]))
```

### 4.2 Grafana Dashboard

业务指标已集成到Grafana Dashboard中，可通过以下面板查看：

- **业务监控面板** (`business-metrics.json`): 
  - 用例生成监控
  - 模型调用监控

## 五、告警阈值建议

### 5.1 用例生成告警

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|---------|---------|------|
| 用例生成失败率 | > 10% | > 20% | 5分钟内失败率超过阈值 |
| 用例生成平均耗时 | > 60秒 | > 120秒 | 5分钟内平均耗时超过阈值 |
| 任务队列长度 | > 100 | > 200 | 待处理任务数超过阈值 |

### 5.2 模型调用告警

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|---------|---------|------|
| 模型调用失败率 | > 5% | > 10% | 5分钟内失败率超过阈值 |
| 模型调用平均耗时 | > 30秒 | > 60秒 | 5分钟内平均耗时超过阈值 |
| 模型调用超时次数 | > 10次/小时 | > 20次/小时 | 1小时内超时次数超过阈值 |
| Token使用量突增 | > 200% | > 300% | 相比前1小时突增超过阈值 |

## 六、指标使用最佳实践

1. **定期监控**: 建议每天查看业务指标Dashboard，及时发现异常
2. **告警配置**: 根据实际业务情况调整告警阈值
3. **趋势分析**: 关注指标趋势，提前发现潜在问题
4. **成本分析**: 通过Token使用量指标分析模型调用成本
5. **性能优化**: 通过耗时指标识别性能瓶颈

## 七、指标导出

所有指标自动导出到Prometheus，可通过以下端点访问：

- Java后端: `http://localhost:8080/api/actuator/prometheus`
- Python服务: `http://localhost:8000/metrics`（如果配置了Prometheus客户端）

## 八、注意事项

1. **采样率**: 生产环境建议根据实际情况调整采样率，避免指标过多影响性能
2. **指标保留**: Prometheus默认保留30天数据，可根据需要调整
3. **标签使用**: 合理使用标签，避免标签组合过多导致指标爆炸
4. **性能影响**: 指标收集对性能影响很小，但大量指标可能影响Prometheus性能

---

**文档版本**: 1.0  
**更新日期**: 2024-01-13  
**维护人**: 系统开发团队

