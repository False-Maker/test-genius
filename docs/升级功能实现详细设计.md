# 测试设计助手系统升级功能实现详细设计

## 一、文档说明

### 1.1 文档目的
本文档基于OCR识别结果与项目实现差异分析报告，详细设计缺失功能的实现方案，包括测试执行模块、测试评估模块、规约驱动测试设计和设计文档生成等功能的详细设计。

### 1.2 设计依据
- **差异分析报告**：`docs/OCR识别结果与项目实现差异报告.md`
- **OCR识别结果**：`ocr_results.md`
- **架构设计文档**：`docs/07_测试设计助手系统架构设计方案.md`
- **核心模块设计**：`docs/08_核心模块详细设计-测试设计助手系统.md`
- **当前项目现状**：基于`docs/开发进度报告与路线图.md`了解的项目现状

### 1.3 升级范围
根据优先级排序，本次升级包含以下模块：

**P0 - 高优先级（必须实现）**：
1. **测试执行模块** - 完全缺失
2. **测试评估模块** - 部分缺失

**P1 - 中优先级（建议实现）**：
3. **规约驱动测试设计** - 部分缺失
4. **设计文档生成** - 完全缺失

---

## 二、测试执行模块详细设计（P0）

### 2.1 模块概述

#### 2.1.1 功能定位
测试执行模块是"测试智能体MIMO"全流程能力的重要组成部分，提供UI智能助手功能，支持UI自动化脚本生成、脚本修复和测试执行管理。

#### 2.1.2 核心能力
- **UI脚本生成**：以自然语言为输入，结合页面代码信息，生成可执行的UI自动化脚本
- **UI脚本修复**：以UI脚本为输入，结合报错信息和页面代码信息，修复执行失败的UI自动化脚本
- **测试执行管理**：管理测试执行任务、执行结果、执行日志
- **页面代码理解**：解析和理解页面代码结构
- **元素定位**：智能定位页面元素

### 2.2 数据模型设计

#### 2.2.1 测试执行任务表
```sql
-- 测试执行任务表
CREATE TABLE test_execution_task (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_code VARCHAR(100) UNIQUE NOT NULL COMMENT '任务编码（TASK-YYYYMMDD-序号）',
    task_name VARCHAR(500) NOT NULL COMMENT '任务名称',
    task_type VARCHAR(50) NOT NULL COMMENT '任务类型：AUTO_SCRIPT_GENERATION/AUTO_SCRIPT_REPAIR/MANUAL_EXECUTION',
    requirement_id BIGINT COMMENT '关联需求ID',
    case_id BIGINT COMMENT '关联用例ID',
    case_suite_id BIGINT COMMENT '关联测试套件ID',
    script_type VARCHAR(50) COMMENT '脚本类型：SELENIUM/PLAYWRIGHT/PUPPETEER',
    script_content TEXT COMMENT '脚本内容',
    script_language VARCHAR(50) COMMENT '脚本语言：PYTHON/JAVA/JAVASCRIPT',
    page_code_url VARCHAR(1000) COMMENT '页面代码URL（文件路径或URL）',
    natural_language_desc TEXT COMMENT '自然语言描述（用于脚本生成）',
    error_log TEXT COMMENT '错误日志（用于脚本修复）',
    execution_config TEXT COMMENT '执行配置（JSON格式）',
    task_status VARCHAR(50) NOT NULL DEFAULT 'PENDING' COMMENT '任务状态：PENDING/PROCESSING/SUCCESS/FAILED',
    progress INT DEFAULT 0 COMMENT '任务进度（0-100）',
    success_count INT DEFAULT 0 COMMENT '成功数量',
    fail_count INT DEFAULT 0 COMMENT '失败数量',
    result_data TEXT COMMENT '结果数据（JSON格式）',
    error_message TEXT COMMENT '错误信息',
    creator_id BIGINT,
    creator_name VARCHAR(100),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    finish_time TIMESTAMP COMMENT '完成时间',
    INDEX idx_task_code (task_code),
    INDEX idx_status (task_status),
    INDEX idx_requirement_id (requirement_id),
    INDEX idx_case_id (case_id),
    FOREIGN KEY (requirement_id) REFERENCES test_requirement(id),
    FOREIGN KEY (case_id) REFERENCES test_case(id)
) COMMENT '测试执行任务表';
```

#### 2.2.2 测试执行记录表
```sql
-- 测试执行记录表
CREATE TABLE test_execution_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    record_code VARCHAR(100) UNIQUE NOT NULL COMMENT '执行记录编码（REC-YYYYMMDD-序号）',
    task_id BIGINT NOT NULL COMMENT '执行任务ID',
    case_id BIGINT COMMENT '关联用例ID',
    execution_type VARCHAR(50) NOT NULL COMMENT '执行类型：MANUAL/AUTOMATED',
    execution_status VARCHAR(50) NOT NULL COMMENT '执行状态：PENDING/RUNNING/SUCCESS/FAILED/SKIPPED',
    execution_result TEXT COMMENT '执行结果详情',
    execution_log TEXT COMMENT '执行日志',
    error_message TEXT COMMENT '错误信息',
    execution_duration INT COMMENT '执行耗时（毫秒）',
    executed_by BIGINT COMMENT '执行人ID',
    executed_by_name VARCHAR(100) COMMENT '执行人姓名',
    execution_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '执行时间',
    finish_time TIMESTAMP COMMENT '完成时间',
    screenshot_url VARCHAR(1000) COMMENT '截图URL（失败时）',
    video_url VARCHAR(1000) COMMENT '视频URL（可选）',
    INDEX idx_task_id (task_id),
    INDEX idx_case_id (case_id),
    INDEX idx_status (execution_status),
    INDEX idx_execution_time (execution_time),
    FOREIGN KEY (task_id) REFERENCES test_execution_task(id),
    FOREIGN KEY (case_id) REFERENCES test_case(id)
) COMMENT '测试执行记录表';
```

#### 2.2.3 UI脚本模板表
```sql
-- UI脚本模板表
CREATE TABLE ui_script_template (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    template_code VARCHAR(100) UNIQUE NOT NULL COMMENT '模板编码（TMP-YYYYMMDD-序号）',
    template_name VARCHAR(500) NOT NULL COMMENT '模板名称',
    template_type VARCHAR(50) NOT NULL COMMENT '模板类型：SELENIUM/PLAYWRIGHT/PUPPETEER',
    script_language VARCHAR(50) NOT NULL COMMENT '脚本语言：PYTHON/JAVA/JAVASCRIPT',
    template_content TEXT NOT NULL COMMENT '模板内容',
    template_variables TEXT COMMENT '模板变量定义（JSON格式）',
    applicable_scenarios TEXT COMMENT '适用场景描述',
    template_description TEXT COMMENT '模板描述',
    version INT DEFAULT 1 COMMENT '版本号',
    is_active CHAR(1) DEFAULT '1' COMMENT '是否启用：1-启用，0-禁用',
    creator_id BIGINT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_template_code (template_code),
    INDEX idx_type (template_type),
    INDEX idx_is_active (is_active)
) COMMENT 'UI脚本模板表';
```

#### 2.2.4 页面元素信息表
```sql
-- 页面元素信息表
CREATE TABLE page_element_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    element_code VARCHAR(100) UNIQUE NOT NULL COMMENT '元素编码',
    page_url VARCHAR(1000) NOT NULL COMMENT '页面URL',
    element_type VARCHAR(50) COMMENT '元素类型：BUTTON/INPUT/LINK/SELECT等',
    element_locator_type VARCHAR(50) COMMENT '定位方式：ID/CLASS/XPATH/CSS_SELECTOR',
    element_locator_value VARCHAR(500) COMMENT '定位值',
    element_text VARCHAR(500) COMMENT '元素文本',
    element_attributes TEXT COMMENT '元素属性（JSON格式）',
    page_structure TEXT COMMENT '页面结构（JSON格式）',
    screenshot_url VARCHAR(1000) COMMENT '截图URL',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_page_url (page_url(255)),
    INDEX idx_element_code (element_code)
) COMMENT '页面元素信息表';
```

### 2.3 功能模块设计

#### 2.3.1 UI脚本生成服务

**功能描述**：以自然语言为输入，结合页面代码信息，生成可执行的UI自动化脚本。

**核心功能**：
1. **自然语言解析**：
   - 解析自然语言描述（操作元素名称+操作步骤）
   - 提取操作类型（点击、输入、选择等）
   - 提取目标元素信息

2. **页面代码理解**：
   - 解析页面HTML/CSS/JavaScript代码
   - 提取页面元素信息
   - 生成元素定位策略

3. **脚本生成**：
   - 根据脚本类型（Selenium/Playwright）选择模板
   - 填充模板变量生成脚本
   - 生成完整的可执行脚本

**接口设计**：
```java
/**
 * UI脚本生成服务接口
 */
public interface UIScriptGenerationService {
    /**
     * 生成UI脚本
     * @param request 脚本生成请求
     * @return 生成任务ID
     */
    String generateScript(UIScriptGenerationRequest request);
    
    /**
     * 查询生成任务状态
     * @param taskCode 任务编码
     * @return 任务状态信息
     */
    UIScriptGenerationTask getTaskStatus(String taskCode);
    
    /**
     * 解析页面代码
     * @param pageCodeUrl 页面代码URL或文件路径
     * @return 页面元素信息列表
     */
    List<PageElementInfo> parsePageCode(String pageCodeUrl);
}
```

**Python AI服务接口**：
```python
# UI脚本生成API
@app.post("/api/v1/ui-script/generate")
async def generate_ui_script(request: UIScriptGenerationRequest):
    """
    生成UI自动化脚本
    - 输入：自然语言描述、页面代码信息
    - 输出：可执行的UI自动化脚本
    """
    pass

@app.post("/api/v1/ui-script/parse-page")
async def parse_page_code(page_code_url: str):
    """
    解析页面代码
    - 输入：页面代码URL或文件路径
    - 输出：页面元素信息列表
    """
    pass
```

#### 2.3.2 UI脚本修复服务

**功能描述**：以UI脚本为输入，结合报错信息和页面代码信息，修复执行失败的UI自动化脚本。

**核心功能**：
1. **错误分析**：
   - 解析错误日志堆栈
   - 识别错误类型（元素定位失败、超时、元素不可见等）
   - 提取错误上下文信息

2. **页面变化检测**：
   - 对比当前页面代码和脚本生成时的页面代码
   - 检测元素定位信息变化
   - 识别页面结构变化

3. **脚本修复**：
   - 更新元素定位信息
   - 调整等待策略
   - 修复脚本逻辑错误
   - 生成修复后的脚本

**接口设计**：
```java
/**
 * UI脚本修复服务接口
 */
public interface UIScriptRepairService {
    /**
     * 修复UI脚本
     * @param request 脚本修复请求
     * @return 修复任务ID
     */
    String repairScript(UIScriptRepairRequest request);
    
    /**
     * 查询修复任务状态
     * @param taskCode 任务编码
     * @return 任务状态信息
     */
    UIScriptRepairTask getTaskStatus(String taskCode);
}
```

**Python AI服务接口**：
```python
@app.post("/api/v1/ui-script/repair")
async def repair_ui_script(request: UIScriptRepairRequest):
    """
    修复UI自动化脚本
    - 输入：UI脚本、报错日志、页面代码信息
    - 输出：修复后的UI自动化脚本
    """
    pass
```

#### 2.3.3 测试执行管理服务

**功能描述**：管理测试执行任务、执行结果、执行日志。

**核心功能**：
1. **执行任务管理**：
   - 创建执行任务
   - 任务状态管理
   - 任务进度跟踪

2. **执行结果管理**：
   - 记录执行结果
   - 执行统计分析
   - 执行趋势分析

3. **执行日志管理**：
   - 执行日志存储
   - 日志查询和检索
   - 日志分析

**接口设计**：
```java
/**
 * 测试执行管理服务接口
 */
public interface TestExecutionService {
    /**
     * 创建执行任务
     * @param request 执行任务请求
     * @return 任务ID
     */
    String createExecutionTask(ExecutionTaskRequest request);
    
    /**
     * 执行任务
     * @param taskCode 任务编码
     * @return 执行记录ID
     */
    String executeTask(String taskCode);
    
    /**
     * 查询执行记录
     * @param taskCode 任务编码
     * @return 执行记录列表
     */
    List<ExecutionRecord> getExecutionRecords(String taskCode);
    
    /**
     * 查询执行统计
     * @param query 查询条件
     * @return 执行统计信息
     */
    ExecutionStatistics getExecutionStatistics(ExecutionStatisticsQuery query);
}
```

### 2.4 技术实现方案

#### 2.4.1 技术栈选择
- **后端Java**：Spring Boot 3.x（业务逻辑）
- **后端Python**：FastAPI + LangChain（AI能力）
- **前端**：Vue 3 + TypeScript（UI界面）
- **脚本框架**：Selenium、Playwright（支持的脚本类型）
- **页面解析**：BeautifulSoup、lxml（HTML解析）

#### 2.4.2 实现步骤

**第一阶段：基础功能（2周）**
1. 数据库表结构创建
2. 实体类和Repository层实现
3. 基础Service层实现
4. API接口定义

**第二阶段：UI脚本生成（2周）**
1. Python AI服务：页面代码解析功能
2. Python AI服务：自然语言理解功能
3. Python AI服务：脚本生成功能
4. Java后端：脚本生成服务集成

**第三阶段：UI脚本修复（1.5周）**
1. Python AI服务：错误分析功能
2. Python AI服务：页面变化检测功能
3. Python AI服务：脚本修复功能
4. Java后端：脚本修复服务集成

**第四阶段：测试执行管理（1周）**
1. 执行任务管理功能
2. 执行结果记录功能
3. 执行统计分析功能

**第五阶段：前端界面（1.5周）**
1. UI脚本生成页面
2. UI脚本修复页面
3. 测试执行管理页面
4. 执行结果展示页面

---

## 三、测试评估模块详细设计（P0）

### 3.1 模块概述

#### 3.1.1 功能定位
测试评估模块是"测试智能体MIMO"的重要组成部分，提供测试结果分析、测试报告生成、测试覆盖分析等功能。

#### 3.1.2 核心能力
- **测试报告生成**：自动生成测试报告，支持多种报告模板
- **测试结果评估**：分析测试执行结果，提供质量建议
- **测试覆盖分析**：分析测试覆盖情况，生成覆盖报告
- **风险评估**：评估交付风险与上线可行性
- **投产前检查**：投产前检查清单和检查报告

### 3.2 数据模型设计

#### 3.2.1 测试报告表
```sql
-- 测试报告表
CREATE TABLE test_report (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    report_code VARCHAR(100) UNIQUE NOT NULL COMMENT '报告编码（RPT-YYYYMMDD-序号）',
    report_name VARCHAR(500) NOT NULL COMMENT '报告名称',
    report_type VARCHAR(50) NOT NULL COMMENT '报告类型：EXECUTION/COVERAGE/QUALITY/RISK',
    template_id BIGINT COMMENT '报告模板ID',
    requirement_id BIGINT COMMENT '关联需求ID',
    execution_task_id BIGINT COMMENT '关联执行任务ID',
    report_content TEXT COMMENT '报告内容（JSON格式）',
    report_summary TEXT COMMENT '报告摘要',
    report_status VARCHAR(50) NOT NULL DEFAULT 'DRAFT' COMMENT '报告状态：DRAFT/PUBLISHED',
    generate_config TEXT COMMENT '生成配置（JSON格式）',
    file_url VARCHAR(1000) COMMENT '报告文件URL（Word/PDF）',
    file_format VARCHAR(50) COMMENT '文件格式：WORD/PDF/EXCEL',
    creator_id BIGINT,
    creator_name VARCHAR(100),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    publish_time TIMESTAMP COMMENT '发布时间',
    INDEX idx_report_code (report_code),
    INDEX idx_report_type (report_type),
    INDEX idx_requirement_id (requirement_id),
    FOREIGN KEY (requirement_id) REFERENCES test_requirement(id),
    FOREIGN KEY (execution_task_id) REFERENCES test_execution_task(id)
) COMMENT '测试报告表';
```

#### 3.2.2 测试报告模板表
```sql
-- 测试报告模板表
CREATE TABLE test_report_template (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    template_code VARCHAR(100) UNIQUE NOT NULL COMMENT '模板编码（TMP-YYYYMMDD-序号）',
    template_name VARCHAR(500) NOT NULL COMMENT '模板名称',
    template_type VARCHAR(50) NOT NULL COMMENT '模板类型：EXECUTION/COVERAGE/QUALITY/RISK',
    template_content TEXT NOT NULL COMMENT '模板内容（JSON格式）',
    template_variables TEXT COMMENT '模板变量定义（JSON格式）',
    file_format VARCHAR(50) COMMENT '文件格式：WORD/PDF/EXCEL',
    template_description TEXT COMMENT '模板描述',
    is_default CHAR(1) DEFAULT '0' COMMENT '是否默认模板：1-是，0-否',
    is_active CHAR(1) DEFAULT '1' COMMENT '是否启用：1-启用，0-禁用',
    version INT DEFAULT 1 COMMENT '版本号',
    creator_id BIGINT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_template_code (template_code),
    INDEX idx_template_type (template_type)
) COMMENT '测试报告模板表';
```

#### 3.2.3 测试覆盖分析表
```sql
-- 测试覆盖分析表
CREATE TABLE test_coverage_analysis (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    analysis_code VARCHAR(100) UNIQUE NOT NULL COMMENT '分析编码（COV-YYYYMMDD-序号）',
    analysis_name VARCHAR(500) NOT NULL COMMENT '分析名称',
    requirement_id BIGINT COMMENT '关联需求ID',
    coverage_type VARCHAR(50) NOT NULL COMMENT '覆盖类型：REQUIREMENT/FUNCTION/SCENARIO/CODE',
    total_items INT COMMENT '总项数',
    covered_items INT COMMENT '已覆盖项数',
    coverage_rate DECIMAL(5,2) COMMENT '覆盖率（百分比）',
    uncovered_items TEXT COMMENT '未覆盖项列表（JSON格式）',
    coverage_details TEXT COMMENT '覆盖详情（JSON格式）',
    analysis_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    analyzer_id BIGINT,
    INDEX idx_analysis_code (analysis_code),
    INDEX idx_requirement_id (requirement_id),
    INDEX idx_coverage_type (coverage_type),
    FOREIGN KEY (requirement_id) REFERENCES test_requirement(id)
) COMMENT '测试覆盖分析表';
```

#### 3.2.4 风险评估表
```sql
-- 风险评估表
CREATE TABLE test_risk_assessment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    assessment_code VARCHAR(100) UNIQUE NOT NULL COMMENT '评估编码（RISK-YYYYMMDD-序号）',
    assessment_name VARCHAR(500) NOT NULL COMMENT '评估名称',
    requirement_id BIGINT COMMENT '关联需求ID',
    execution_task_id BIGINT COMMENT '关联执行任务ID',
    risk_level VARCHAR(50) COMMENT '风险等级：HIGH/MEDIUM/LOW',
    risk_score DECIMAL(5,2) COMMENT '风险评分（0-100）',
    risk_items TEXT COMMENT '风险项列表（JSON格式）',
    feasibility_score DECIMAL(5,2) COMMENT '上线可行性评分（0-100）',
    feasibility_recommendation TEXT COMMENT '上线建议',
    assessment_details TEXT COMMENT '评估详情（JSON格式）',
    assessment_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assessor_id BIGINT,
    INDEX idx_assessment_code (assessment_code),
    INDEX idx_requirement_id (requirement_id),
    INDEX idx_risk_level (risk_level),
    FOREIGN KEY (requirement_id) REFERENCES test_requirement(id),
    FOREIGN KEY (execution_task_id) REFERENCES test_execution_task(id)
) COMMENT '风险评估表';
```

### 3.3 功能模块设计

#### 3.3.1 测试报告生成服务

**功能描述**：自动生成测试报告，支持多种报告模板和格式。

**核心功能**：
1. **报告模板管理**：
   - 报告模板创建和编辑
   - 模板变量定义
   - 模板分类管理

2. **报告生成**：
   - 测试结果汇总
   - 测试覆盖分析
   - 质量评估结果
   - 风险评估
   - 改进建议

3. **报告导出**：
   - Word格式导出
   - PDF格式导出
   - Excel格式导出

**接口设计**：
```java
/**
 * 测试报告生成服务接口
 */
public interface TestReportService {
    /**
     * 生成测试报告
     * @param request 报告生成请求
     * @return 报告ID
     */
    String generateReport(ReportGenerationRequest request);
    
    /**
     * 查询报告详情
     * @param reportCode 报告编码
     * @return 报告详情
     */
    TestReport getReport(String reportCode);
    
    /**
     * 导出报告文件
     * @param reportCode 报告编码
     * @param format 文件格式
     * @return 文件URL
     */
    String exportReport(String reportCode, String format);
    
    /**
     * 查询报告列表
     * @param query 查询条件
     * @return 报告列表
     */
    Page<TestReport> listReports(ReportQuery query);
}
```

#### 3.3.2 测试覆盖分析服务

**功能描述**：分析测试覆盖情况，生成覆盖报告。

**核心功能**：
1. **覆盖统计**：
   - 需求覆盖统计
   - 功能覆盖统计
   - 场景覆盖统计
   - 代码覆盖统计（如集成代码覆盖率工具）

2. **覆盖报告**：
   - 覆盖详情展示
   - 覆盖趋势分析
   - 覆盖不足提醒

**接口设计**：
```java
/**
 * 测试覆盖分析服务接口
 */
public interface TestCoverageService {
    /**
     * 分析测试覆盖
     * @param request 覆盖分析请求
     * @return 分析结果ID
     */
    String analyzeCoverage(CoverageAnalysisRequest request);
    
    /**
   