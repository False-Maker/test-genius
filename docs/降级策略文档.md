# 降级策略文档

## 一、概述

本文档说明测试设计助手系统的降级策略，包括模型降级和功能降级机制，用于提升系统的稳定性和可用性。

## 二、降级策略类型

### 2.1 模型降级

当主模型不可用时，自动切换到备用模型，确保服务可用性。

### 2.2 功能降级

当系统负载过高时，自动关闭非核心功能，保证核心功能可用。

## 三、模型降级策略

### 3.1 降级触发条件

模型降级在以下情况下触发：

1. **主模型调用失败**: 主模型API调用失败（网络错误、超时等）
2. **主模型返回错误**: 主模型返回错误响应
3. **主模型不可用**: 主模型服务不可用

### 3.2 降级流程

```
1. 尝试使用主模型
   ↓
2. 主模型调用失败？
   ↓ 是
3. 获取备用模型列表（按优先级排序）
   ↓
4. 尝试下一个模型
   ↓
5. 成功？
   ↓ 是
6. 记录降级事件
   ↓
7. 返回结果
```

### 3.3 模型优先级

模型优先级通过数据库中的`priority`字段定义：

- **优先级数字越小，优先级越高**
- 系统按优先级从高到低尝试模型
- 如果指定了首选模型，优先使用首选模型

### 3.4 降级实现

降级逻辑在`AIServiceClientImpl`中实现：

```java
public Map<String, Object> postWithFallback(String url, Object request, String preferredModelCode) {
    // 获取模型列表（按优先级排序）
    List<ModelConfig> activeModels = modelConfigService.getActiveModelConfigs();
    
    // 尝试每个模型
    for (ModelConfig model : modelsToTry) {
        try {
            // 尝试调用模型
            return doPost(url, request);
        } catch (Exception e) {
            // 记录失败，继续尝试下一个模型
            log.warn("模型 {} 调用失败: {}", model.getModelCode(), e.getMessage());
        }
    }
    
    // 所有模型都失败
    throw new RuntimeException("所有模型调用都失败");
}
```

### 3.5 降级监控

降级事件会记录到以下位置：

1. **日志**: 记录降级日志，包含主模型和备用模型信息
2. **指标**: 记录降级指标到Prometheus
3. **告警**: 降级次数过多时触发告警

## 四、功能降级策略

### 4.1 功能开关配置

功能开关通过`FeatureFlagConfig`配置类管理：

```yaml
app:
  feature-flag:
    model-fallback-enabled: true  # 是否启用模型降级策略
    case-generation-enabled: true  # 是否启用用例生成功能
    case-quality-assessment-enabled: true  # 是否启用用例质量评估功能
    case-reuse-enabled: true  # 是否启用用例复用功能
    knowledge-base-enabled: true  # 是否启用知识库功能
    system-load-threshold: 80  # 系统负载阈值（CPU使用率百分比）
    auto-degrade-enabled: false  # 是否启用自动降级
```

### 4.2 功能分类

#### 核心功能（不可降级）
- 需求管理
- 用例管理
- 基础查询功能

#### 非核心功能（可降级）
- 用例生成（AI功能）
- 用例质量评估
- 用例复用
- 知识库

### 4.3 自动降级

当`auto-degrade-enabled`为`true`时，系统会根据负载自动降级：

1. **监控系统负载**: 监控CPU使用率
2. **判断负载阈值**: 如果超过`system-load-threshold`，触发降级
3. **关闭非核心功能**: 自动关闭非核心功能
4. **恢复功能**: 负载降低后，自动恢复功能

### 4.4 手动降级

管理员可以通过配置手动降级：

1. **修改配置**: 修改`application.yml`中的功能开关
2. **重启服务**: 重启服务使配置生效
3. **或使用配置中心**: 如果集成了配置中心，可以动态修改

## 五、降级恢复机制

### 5.1 模型降级恢复

模型降级是临时性的，每次请求都会尝试主模型：

- **下次请求**: 下次请求时，会重新尝试主模型
- **自动恢复**: 主模型恢复后，自动使用主模型
- **无需手动干预**: 无需手动恢复

### 5.2 功能降级恢复

功能降级恢复需要手动操作：

1. **自动降级恢复**: 如果启用了自动降级，负载降低后自动恢复
2. **手动恢复**: 修改配置，重启服务

## 六、降级监控和告警

### 6.1 降级指标

系统收集以下降级指标：

- **降级次数**: 记录降级事件次数
- **降级原因**: 记录降级原因（按模型、按功能分类）
- **降级持续时间**: 记录降级持续时间

### 6.2 告警规则

建议配置以下告警规则：

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|---------|---------|------|
| 模型降级次数 | > 10次/小时 | > 20次/小时 | 1小时内降级次数超过阈值 |
| 功能降级状态 | 持续 > 30分钟 | 持续 > 1小时 | 功能降级持续时间超过阈值 |

### 6.3 Grafana Dashboard

降级监控已集成到Grafana Dashboard中，可以通过以下面板查看：

- **业务监控面板**: 查看降级指标
- **告警面板**: 查看降级告警

## 七、最佳实践

### 7.1 模型配置

1. **配置多个模型**: 建议配置至少2个模型，确保有备用模型
2. **合理设置优先级**: 根据模型性能和成本设置优先级
3. **定期检查模型状态**: 定期检查模型配置的可用性

### 7.2 功能开关

1. **谨慎使用自动降级**: 生产环境建议谨慎使用自动降级
2. **明确功能分类**: 明确区分核心功能和非核心功能
3. **及时恢复**: 问题解决后，及时恢复功能

### 7.3 监控和告警

1. **配置告警**: 配置降级告警，及时发现异常
2. **定期检查**: 定期检查降级指标，分析降级原因
3. **优化改进**: 根据降级情况，优化系统配置

## 八、故障处理

### 8.1 所有模型都失败

**问题**: 所有模型调用都失败

**处理步骤**:
1. 检查模型配置是否正确
2. 检查网络连接是否正常
3. 检查模型服务是否可用
4. 检查API密钥是否有效

### 8.2 功能降级后无法恢复

**问题**: 功能降级后无法恢复

**处理步骤**:
1. 检查配置是否正确
2. 检查系统负载是否正常
3. 检查服务是否正常运行
4. 手动修改配置，重启服务

## 九、配置示例

### 9.1 完整配置示例

```yaml
app:
  feature-flag:
    # 模型降级
    model-fallback-enabled: true
    
    # 功能开关
    case-generation-enabled: true
    case-quality-assessment-enabled: true
    case-reuse-enabled: true
    knowledge-base-enabled: true
    
    # 自动降级
    system-load-threshold: 80
    auto-degrade-enabled: false  # 生产环境建议关闭
```

### 9.2 紧急降级配置

当系统出现严重问题时，可以快速降级：

```yaml
app:
  feature-flag:
    model-fallback-enabled: true
    case-generation-enabled: false  # 关闭用例生成
    case-quality-assessment-enabled: false  # 关闭质量评估
    case-reuse-enabled: false  # 关闭用例复用
    knowledge-base-enabled: false  # 关闭知识库
```

## 十、注意事项

1. **降级影响**: 降级会影响用户体验，应谨慎使用
2. **监控告警**: 必须配置监控和告警，及时发现异常
3. **恢复机制**: 确保有明确的恢复机制
4. **文档记录**: 记录降级事件和处理过程
5. **定期演练**: 定期进行降级演练，确保降级机制有效

---

**文档版本**: 1.0  
**更新日期**: 2024-01-13  
**维护人**: 系统开发团队

