# Controller 测试问题修复指南

## 问题汇总

根据分析，Controller 测试存在以下主要问题：

1. **删除测试缺少 Mock 配置**（约 10 个）
2. **Mock 配置问题**（约 25 个）
   - 缺少 EntityDTOMapper Mock
   - 更新测试缺少前置 getById Mock
   - 缺少 updateFromDTO Mock
3. **业务逻辑验证问题**（约 10 个）
4. **空指针异常**（约 5 个）
5. **其他问题**（约 9 个）

## 已修复的测试

### 1. RequirementControllerTest
- ✅ 修复删除测试的 Mock 配置（testDeleteRequirement_Success）

### 2. TestCaseControllerTest
- ✅ 修复删除测试的 Mock 配置（testDeleteTestCase_Success）
- ✅ 修复更新测试的前置 Mock（testUpdateTestCase_Success）
- ✅ 添加 EntityDTOMapper MockBean

### 3. PromptTemplateControllerTest
- ✅ 修复删除测试的 Mock 配置（testDeleteTemplate_Success）
- ✅ 修复更新测试的前置 Mock（testUpdateTemplate_Success）
- ✅ 添加 EntityDTOMapper MockBean

## 常见问题模式及修复方法

### 问题 1：删除测试缺少 Mock 配置

**问题描述**：
删除测试中缺少 `doNothing().when(service).deleteXxx(id)` 的 Mock 配置，导致测试失败。

**修复方法**：
```java
@Test
@DisplayName("删除XXX-成功")
void testDeleteXxx_Success() throws Exception {
    // Given
    Long id = 1L;
    
    // 添加这行
    doNothing().when(service).deleteXxx(id);
    
    // When & Then
    mockMvc.perform(delete("/v1/xxx/{id}", id))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200));
}
```

**需要修复的测试**：
- ModelConfigControllerTest
- TestReportControllerTest
- TestCoverageControllerTest
- TestSpecificationControllerTest
- UIScriptTemplateControllerTest
- TestReportTemplateControllerTest
- 其他 Controller 的删除测试

### 问题 2：更新测试缺少前置 getById Mock

**问题描述**：
Controller 的更新方法通常会先调用 `getXxxById(id)` 获取现有实体，但测试中没有 Mock 这个方法，导致空指针异常。

**修复方法**：
```java
@Test
@DisplayName("更新XXX-成功")
void testUpdateXxx_Success() throws Exception {
    // Given
    Long id = 1L;
    XxxDto dto = new XxxDto();
    dto.setName("更新后的名称");
    
    // 添加这两行：先 Mock getById
    XxxEntity existingEntity = new XxxEntity();
    existingEntity.setId(id);
    existingEntity.setName("原名称");
    
    XxxEntity updatedEntity = new XxxEntity();
    updatedEntity.setId(id);
    updatedEntity.setName("更新后的名称");
    
    // 添加 getById 的 Mock
    when(service.getXxxById(id))
        .thenReturn(existingEntity);
    // 添加 updateFromDTO 的 Mock（如果需要）
    doNothing().when(entityDTOMapper).updateXxxFromDTO(any(), any(XxxEntity.class));
    when(service.updateXxx(eq(id), any(XxxEntity.class)))
        .thenReturn(updatedEntity);
    
    // When & Then
    mockMvc.perform(put("/v1/xxx/{id}", id)
            .contentType(MediaType.APPLICATION_JSON)
            .content(objectMapper.writeValueAsString(dto)))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200))
            .andExpect(jsonPath("$.data.name").value("更新后的名称"));
}
```

**需要修复的测试**：
- ModelConfigControllerTest
- PromptTemplateControllerTest（已修复）
- TestCaseControllerTest（已修复）
- 其他 Controller 的更新测试

### 问题 3：缺少 EntityDTOMapper Mock

**问题描述**：
Controller 依赖 `EntityDTOMapper` 进行 DTO 和 Entity 之间的转换，但测试中没有声明 `@MockBean`。

**修复方法**：
```java
@DisplayName("XXX管理Controller测试")
class XxxControllerTest extends BaseControllerTest {
    
    @MockBean
    private XxxService xxxService;
    
    // 添加这行
    @MockBean
    private EntityDTOMapper entityDTOMapper;
    
    // ...
}
```

**需要修复的测试**：
- TestCaseControllerTest（已修复）
- PromptTemplateControllerTest（已修复）
- ModelConfigControllerTest
- TestReportControllerTest
- TestCoverageControllerTest
- TestSpecificationControllerTest
- UIScriptTemplateControllerTest
- TestReportTemplateControllerTest
- PageElementControllerTest
- TestExecutionControllerTest
- TestRiskAssessmentControllerTest

### 问题 4：缺少 updateFromDTO Mock

**问题描述**：
更新测试中，Controller 会调用 `entityDTOMapper.updateXxxFromDTO(dto, entity)`，但测试中没有 Mock 这个方法（void 方法需要使用 `doNothing()`）。

**修复方法**：
```java
doNothing().when(entityDTOMapper).updateXxxFromDTO(any(XxxDto.class), any(XxxEntity.class));
```

**需要修复的测试**：
- 所有有更新测试的 Controller 测试

### 问题 5：导入缺少 doNothing

**问题描述**：
测试中使用了 `doNothing()` 但没有正确导入。

**修复方法**：
```java
// 修改前
import static org.mockito.Mockito.when;

// 修改后
import static org.mockito.Mockito.*;
```

**需要修复的测试**：
- 所有使用 `doNothing()` 的测试文件

## 修复检查清单

### 每个 Controller 测试文件需要检查：

- [ ] 是否缺少 EntityDTOMapper 的 @MockBean 声明
- [ ] 删除测试是否配置了 `doNothing().when(service).deleteXxx(id)`
- [ ] 更新测试是否配置了 `when(service.getXxxById(id)).thenReturn(...)`
- [ ] 更新测试是否配置了 `doNothing().when(entityDTOMapper).updateXxxFromDTO(...)`
- [ ] 创建测试是否配置了 EntityDTOMapper 的相关 Mock（如果需要）
- [ ] 查询测试是否配置了 EntityDTOMapper 的相关 Mock（如果需要）
- [ ] 是否导入了 `import static org.mockito.Mockito.*;`

## 修复步骤

1. **检查 Controller 依赖**：
   - 查看 Controller 类中声明的依赖（`private final` 字段）
   - 确认测试类中是否有对应的 `@MockBean`

2. **检查 Controller 方法实现**：
   - 查看 Controller 方法的实现逻辑
   - 确认测试中是否 Mock 了所有被调用的方法

3. **修复测试用例**：
   - 添加缺少的 `@MockBean`
   - 添加缺少的 `when().thenReturn()` 或 `doNothing().when()`
   - 确保 Mock 的行为与 Controller 的实现一致

4. **运行测试验证**：
   - 运行修复后的测试，确保通过
   - 检查是否有遗漏的问题

## 注意事项

1. **void 方法的 Mock**：
   - 使用 `doNothing().when(service).method()` 而不是 `when(service.method()).thenReturn(null)`

2. **参数匹配**：
   - 使用 `any()` 或 `eq()` 进行参数匹配
   - 确保参数类型正确

3. **方法调用顺序**：
   - Mock 的配置顺序要与 Controller 中的调用顺序一致

4. **DTO 转换**：
   - Controller 通常使用 EntityDTOMapper 进行 DTO 和 Entity 的转换
   - 测试中需要 Mock 这些转换方法

## 相关文件

- 已修复的测试：
  - `RequirementControllerTest.java`
  - `TestCaseControllerTest.java`
  - `PromptTemplateControllerTest.java`

- 需要修复的测试（示例）：
  - `ModelConfigControllerTest.java`
  - `TestReportControllerTest.java`
  - `TestCoverageControllerTest.java`
  - `TestSpecificationControllerTest.java`
  - `UIScriptTemplateControllerTest.java`
  - `TestReportTemplateControllerTest.java`
  - `PageElementControllerTest.java`
  - `TestExecutionControllerTest.java`
  - `TestRiskAssessmentControllerTest.java`
  - 其他 Controller 测试文件

