groups:
  - name: application_alerts
    interval: 30s
    rules:
      # 接口错误率告警
      - alert: HighAPIErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (application, uri)
            /
            sum(rate(http_server_requests_seconds_count[5m])) by (application, uri)
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "接口错误率过高"
          description: "应用 {{ $labels.application }} 的接口 {{ $labels.uri }} 错误率为 {{ $value | humanizePercentage }}，超过5%阈值"

      - alert: CriticalAPIErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (application, uri)
            /
            sum(rate(http_server_requests_seconds_count[5m])) by (application, uri)
          ) * 100 > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "接口错误率严重过高"
          description: "应用 {{ $labels.application }} 的接口 {{ $labels.uri }} 错误率为 {{ $value | humanizePercentage }}，超过10%阈值"

      # 接口响应时间告警
      - alert: HighAPIResponseTime
        expr: |
          histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, application, uri)) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "接口响应时间过长"
          description: "应用 {{ $labels.application }} 的接口 {{ $labels.uri }} 的95分位响应时间为 {{ $value }} 秒，超过3秒阈值"

      - alert: CriticalAPIResponseTime
        expr: |
          histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, application, uri)) > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "接口响应时间严重过长"
          description: "应用 {{ $labels.application }} 的接口 {{ $labels.uri }} 的95分位响应时间为 {{ $value }} 秒，超过10秒阈值"

      # 接口QPS突增告警
      - alert: APIQPSSurge
        expr: |
          (
            sum(rate(http_server_requests_seconds_count[5m])) by (application, uri)
            /
            sum(rate(http_server_requests_seconds_count[15m] offset 10m)) by (application, uri)
          ) > 3
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "接口QPS突增"
          description: "应用 {{ $labels.application }} 的接口 {{ $labels.uri }} 的QPS突增 {{ $value | humanize }} 倍，超过200%阈值"

      # 数据库连接池使用率告警
      - alert: HighDatabaseConnectionPoolUsage
        expr: |
          (hikari_connections_active / hikari_connections_max) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "数据库连接池使用率过高"
          description: "应用 {{ $labels.application }} 的数据库连接池使用率为 {{ $value | humanizePercentage }}，超过80%阈值"

      - alert: CriticalDatabaseConnectionPoolUsage
        expr: |
          (hikari_connections_active / hikari_connections_max) * 100 > 90
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "数据库连接池使用率严重过高"
          description: "应用 {{ $labels.application }} 的数据库连接池使用率为 {{ $value | humanizePercentage }}，超过90%阈值"

      # Redis连接失败告警
      - alert: RedisConnectionFailure
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis连接失败"
          description: "应用 {{ $labels.application }} 无法连接到Redis，连接状态为 {{ $value }}"

      # Redis内存使用率告警
      - alert: HighRedisMemoryUsage
        expr: |
          (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis内存使用率过高"
          description: "Redis内存使用率为 {{ $value | humanizePercentage }}，超过80%阈值"

